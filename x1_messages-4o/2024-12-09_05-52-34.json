[
    {
        "role": "user",
        "content": "How can I change the Tor identity with each request in Python? I have a script that uses Tor and SocksiPy. Here is my current script:\n\n```python\nimport socks\nimport socket\nsocks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, \"127.0.0.1\", 9050)\nsocket.socket = socks.socksocket\nimport urllib2\n\nprint(urllib2.urlopen(\"http://www.ifconfig.me/ip\").read())\n```\n\nNow, I want to change Tor identity within a loop, for instance:\n\n```python\nfor i in range(0, 10):\n    #somehow change tor identity\n    print(urllib2.urlopen(\"http://www.ifconfig.me/ip\").read())\n```\n\nHow can I achieve this?"
    },
    {
        "role": "assistant",
        "content": "To change the Tor identity with each request, you'll need to send a signal to the Tor process to request a new identity. This is typically done via Tor's ControlPort, which allows you to send commands to the Tor process. Here\u2019s how you can modify your script to achieve this:\n\n1. Install the `stem` library, which is a Python controller library for Tor. You can install it via pip:\n\n   ```bash\n   pip install stem\n   ```\n\n2. Modify your script to send a signal for a new identity using the `stem` library. Here\u2019s how you can do it:\n\n```python\nimport socks\nimport socket\nimport urllib2\nfrom stem import Signal\nfrom stem.control import Controller\nimport time\n\ndef renew_tor_identity():\n    with Controller.from_port(port=9051) as controller:\n        controller.authenticate(password='your_password')  # Use the password you set in your torrc file\n        controller.signal(Signal.NEWNYM)\n\nsocks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, \"127.0.0.1\", 9050)\nsocket.socket = socks.socksocket\n\nfor i in range(10):\n    renew_tor_identity()\n    time.sleep(5)  # Wait for Tor to switch IPs\n    print(urllib2.urlopen(\"http://www.ifconfig.me/ip\").read())\n```\n\n### Steps to set up:\n\n1. **Tor Configuration**: You need to configure the Tor service to listen on the ControlPort and set a password for authentication. You can do this by editing your `torrc` file, usually located in `/etc/tor/torrc` or `C:\\Users\\<YourUsername>\\AppData\\Roaming\\tor\\torrc` on Windows. Add or uncomment the following lines:\n\n   ```\n   ControlPort 9051\n   HashedControlPassword <YourHashedPasswordHere>\n   ```\n\n   You can generate a hashed password using the `tor --hash-password your_password` command.\n\n2. **Controller Authentication**: Replace `'your_password'` in the script with the password you set in the `torrc` file.\n\n3. **Timing**: The `time.sleep(5)` is a simple way to ensure that Tor has had enough time to switch IPs before making the next request. Adjust the sleep time if necessary.\n\nWith this setup, your script will request a new Tor identity before each URL request. Remember that frequently changing identities can be resource-intensive and may lead to temporary bans from some sites."
    }
]