[
    {
        "role": "user",
        "content": "I am trying to use Matplotlib on a remote machine, for example Travis CI. However, I keep encountering runtime errors that are related to the DISPLAY environmental variable not being unset. I have made sure to set the Agg backend at the start of my test scripts using matplotlib.use, as recommended, and have made sure there are no calls to show(). Despite this, I am still encountering errors like:\n\n```\nTraceback (most recent call last):\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/nose/case.py\", line 197, in runTest\n    self.test(*self.arg)\n  File \"/home/travis/build/pymc-devs/pymc/pymc/tests/test_plots.py\", line 36, in test_multichain_plots\n    forestplot(ptrace, vars=['early_mean', 'late_mean'])\n  File \"/home/travis/build/pymc-devs/pymc/pymc/plots.py\", line 325, in forestplot\n    interval_plot = subplot(gs[0])\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/pyplot.py\", line 896, in subplot\n    fig = gcf()\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/pyplot.py\", line 450, in gcf\n    return figure()\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/pyplot.py\", line 423, in figure\n    **kwargs)\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/backends/backend_qt4agg.py\", line 31, in new_figure_manager\n    return new_figure_manager_given_figure(num, thisFig)\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/backends/backend_qt4agg.py\", line 38, in new_figure_manager_given_figure\n    canvas = FigureCanvasQTAgg(figure)\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/backends/backend_qt4agg.py\", line 70, in __init__\n    FigureCanvasQT.__init__( self, figure )\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/backends/backend_qt4.py\", line 207, in __init__\n    _create_qApp()\n  File \"/home/travis/anaconda/envs/testenv/lib/python2.7/site-packages/matplotlib/backends/backend_qt4.py\", line 62, in _create_qApp\n    raise RuntimeError('Invalid DISPLAY variable')\nRuntimeError: Invalid DISPLAY variable\n```\n\nAre there any other methods or recommendations to circumvent this issue?"
    },
    {
        "role": "assistant",
        "content": "The issue you're encountering is related to the fact that Matplotlib is defaulting to a backend that requires a display environment, which is not available on headless systems like CI environments. Even though you have set the backend to `Agg`, which is a non-interactive backend suitable for scripts and headless environments, the error suggests that somewhere in the code, the backend is being overridden or not set properly.\n\nHere are a few steps you can take to resolve this issue:\n\n1. **Set the Backend Early**: Make sure that you set the backend to `Agg` at the very beginning of your script, before any other Matplotlib imports. This ensures that the correct backend is used throughout the script:\n\n    ```python\n    import matplotlib\n    matplotlib.use('Agg')\n    import matplotlib.pyplot as plt\n    ```\n\n2. **Check for Backend Overrides**: Search through your code and any imported libraries to ensure that there are no other places where the Matplotlib backend is being set or overridden.\n\n3. **Verify Environment Variables**: Double-check that there are no unintended environment variables affecting the backend, particularly the `DISPLAY` variable. You can unset it in your script:\n\n    ```python\n    import os\n    os.environ.pop('DISPLAY', None)\n    ```\n\n4. **Install Required Packages**: Ensure that all required packages for the `Agg` backend are installed. In some cases, missing dependencies can cause issues even if the backend is set correctly.\n\n5. **Use a Configuration File**: As an alternative, you can set the backend in a `matplotlibrc` configuration file:\n\n    Create a file named `matplotlibrc` with the following content in your project directory:\n\n    ```\n    backend: Agg\n    ```\n\n6. **Disable Interactive Mode**: Ensure that interactive mode is turned off by calling:\n\n    ```python\n    plt.ioff()\n    ```\n\n7. **Debugging**: Add some debugging information to confirm which backend is being used:\n\n    ```python\n    import matplotlib\n    print(\"Current backend:\", matplotlib.get_backend())\n    ```\n\n8. **Check External Libraries**: If you are using external libraries that rely on Matplotlib and set their own backends, you may need to check their documentation or source code to verify how they handle plotting.\n\nImplementing these steps should help you bypass the error related to the `DISPLAY` variable. If the issue persists, consider running a minimal script that only sets the backend to `Agg` and creates a simple plot to isolate the problem further."
    }
]