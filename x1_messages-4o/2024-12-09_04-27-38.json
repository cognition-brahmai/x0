[
    {
        "role": "user",
        "content": "How can I calculate an RFC 2104-compliant HMAC with the SHA256 hash algorithm using a string and a secret key in Python? I am working with the Amazon Product API which requires a signature with every request. My secret key is \"1234567890\" and my string is as follows:\n```\nGET\nwebservices.amazon.com\n/onca/xml\nAWSAccessKeyId=00000000000000000000&ItemId=0679722769&Operation=ItemLookup&ResponseGroup=ItemAttributes%2COffers%2CImages%2CReviews&Service=AWSECommerceService&Timestamp=2009-01-01T12%3A00%3A00Z&Version=2009-01-06\n```\nAccording to Amazon's guidelines, I should get the following signature: `'Nace+U3Az4OhN7tISqgs1vdLBHBEijWcBeCqL5xN9xg='`. However, I am getting: `'411a59403c9f58b4a434c9c6a14ef6e363acc1d1bb2c6faf9adc30e20898c83b'`. What am I doing wrong?"
    },
    {
        "role": "assistant",
        "content": "It looks like you are calculating the HMAC-SHA256 signature correctly, but the output format doesn't match what Amazon requires. Amazon expects the signature to be encoded in Base64, while your output appears to be in hexadecimal format. Here\u2019s how you can calculate an RFC 2104-compliant HMAC with SHA256 and encode it in Base64:\n\n```python\nimport hmac\nimport hashlib\nimport base64\n\n# Your secret key and message\nsecret_key = \"1234567890\"\nstring_to_sign = \"\"\"GET\nwebservices.amazon.com\n/onca/xml\nAWSAccessKeyId=00000000000000000000&ItemId=0679722769&Operation=ItemLookup&ResponseGroup=ItemAttributes%2COffers%2CImages%2CReviews&Service=AWSECommerceService&Timestamp=2009-01-01T12%3A00%3A00Z&Version=2009-01-06\"\"\"\n\n# Create an HMAC object using your secret key and the SHA256 hash algorithm\nhmac_obj = hmac.new(secret_key.encode('utf-8'), string_to_sign.encode('utf-8'), hashlib.sha256)\n\n# Calculate the HMAC and encode it in Base64\nsignature = base64.b64encode(hmac_obj.digest()).decode('utf-8')\n\nprint(signature)\n```\n\nHere's a breakdown of the steps:\n\n1. Encode the secret key and string to sign in UTF-8, as HMAC requires byte inputs.\n2. Create an HMAC object using the secret key, the string to sign, and the SHA256 hash algorithm.\n3. Calculate the HMAC digest and encode it in Base64 to get the final signature that Amazon requires.\n\nRunning this code should give you the correct signature: `'Nace+U3Az4OhN7tISqgs1vdLBHBEijWcBeCqL5xN9xg='`. Make sure your string to sign and secret key are exactly as expected to avoid discrepancies."
    }
]