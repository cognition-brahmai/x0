[
    {
        "role": "user",
        "content": "How can I use Python's smtplib.sendmail function to send an email to multiple recipients? I've been trying to figure it out but every time I try, the mail headers seem to contain multiple addresses, but only the first recipient actually receives the email. The issue seems to lie with how the email.Message module and smtplib.sendmail() function handle recipients differently. What is the correct way to format the recipient addresses in the header and to_addrs parameter to ensure all recipients receive the email?"
    },
    {
        "role": "assistant",
        "content": "When using Python's `smtplib` to send emails to multiple recipients, it's important to distinguish between the headers in the email and the parameters you pass to the `smtplib.sendmail()` function. Here's how you can properly format and send an email to multiple recipients:\n\n### Step-by-Step Guide\n\n1. **Import Required Libraries**: You'll need `smtplib` for sending the email and `email.message.EmailMessage` to create the email content.\n\n2. **Create the Email Message**:\n   - Set the `From`, `To`, and `Subject` headers.\n   - Use the `To` header for display purposes (i.e., what recipients will see as the \"To\" field).\n   - Pass the actual list of recipients to the `smtplib.sendmail()` function.\n\n3. **Specify Multiple Recipients**:\n   - In the `To` header, join the list of recipient email addresses with a comma.\n   - In the `sendmail()` call, pass the list of recipient email addresses to the `to_addrs` parameter.\n\n### Example Code:\n\n```python\nimport smtplib\nfrom email.message import EmailMessage\n\n# Set up the email details\nsender_email = \"your_email@example.com\"\nrecipients = [\"recipient1@example.com\", \"recipient2@example.com\", \"recipient3@example.com\"]\nsubject = \"Subject of the Email\"\nbody = \"This is the body of the email.\"\n\n# Create the email message\nmsg = EmailMessage()\nmsg.set_content(body)\nmsg['From'] = sender_email\nmsg['To'] = \", \".join(recipients)  # For display purposes in the email header\nmsg['Subject'] = subject\n\n# Send the email\nsmtp_server = \"smtp.example.com\"  # Replace with your SMTP server\nsmtp_port = 587  # Replace with your SMTP server port\n\ntry:\n    with smtplib.SMTP(smtp_server, smtp_port) as server:\n        server.starttls()  # Upgrade the connection to secure\n        server.login(\"your_email@example.com\", \"your_password\")  # Log in to your email account\n        server.sendmail(sender_email, recipients, msg.as_string())  # Send the email\n        print(\"Email sent successfully to all recipients.\")\nexcept Exception as e:\n    print(f\"An error occurred: {e}\")\n```\n\n### Key Points:\n\n- The `msg['To']` header is just for display; it doesn't determine where the email is sent. The list of recipients passed to `sendmail()` does.\n- Ensure that your SMTP server allows sending emails to multiple recipients. Some servers might have restrictions or require specific settings.\n- Always secure your SMTP connection with `starttls()` if using a non-secure port and handle any exceptions that might arise during sending to ensure your program can handle errors gracefully.\n\nBy following these steps, all your intended recipients should receive the email, and the headers should be correctly formatted."
    }
]