[
    {
        "role": "user",
        "content": "How can I configure Celery to send periodic tasks to a specific queue, 'celery_periodic', instead of the default 'celery' queue? Here is my current setup:\n\nTask decorator:\n```python\n@task(queue='celery_periodic')\ndef recalc_last_hour():\n    log.debug('sending new task')\n    recalc_hour.delay(datetime(2013, 1, 1, 2)) # for example\n```\nScheduler settings:\n```python\nCELERYBEAT_SCHEDULE = {\n   'installer_recalc_hour': {\n        'task': 'stats.installer.tasks.recalc_last_hour',\n        'schedule': 15  # every 15 sec for test\n    },\n}\nCELERYBEAT_SCHEDULER = \"djcelery.schedulers.DatabaseScheduler\"\n```\nCommand to run the worker:\n```bash\npython manage.py celery worker -c 1 -Q celery_periodic -B -E\n```\nDespite these settings, the worker is still sending periodic tasks to the 'celery' queue, not the 'celery_periodic' queue. How can I fix this? I'm using celery version 3.0.16."
    },
    {
        "role": "assistant",
        "content": "To configure Celery to send periodic tasks to a specific queue, you need to ensure that both the task and the periodic task configuration specify the desired queue. The issue you are facing is likely due to the periodic task configuration not explicitly setting the queue. Here's how you can fix this:\n\n1. **Specify the Queue in the CELERYBEAT_SCHEDULE**: You need to add the `options` key in your `CELERYBEAT_SCHEDULE` configuration to specify the queue. Update your `CELERYBEAT_SCHEDULE` as follows:\n\n   ```python\n   CELERYBEAT_SCHEDULE = {\n       'installer_recalc_hour': {\n           'task': 'stats.installer.tasks.recalc_last_hour',\n           'schedule': 15,  # every 15 sec for test\n           'options': {\n               'queue': 'celery_periodic',\n           },\n       },\n   }\n   ```\n\n2. **Ensure the Worker is Listening to the Correct Queue**: When you start your worker, ensure it is listening to the `celery_periodic` queue and that it is running with the `-B` flag to enable the Celery Beat scheduler:\n\n   ```bash\n   python manage.py celery worker -c 1 -Q celery_periodic -B -E\n   ```\n\n3. **Verify Task Queue in Task Declaration**: Your task decorator specifies the queue correctly, but it is good to ensure consistency:\n\n   ```python\n   @task(queue='celery_periodic')\n   def recalc_last_hour():\n       log.debug('sending new task')\n       recalc_hour.delay(datetime(2013, 1, 1, 2))  # for example\n   ```\n\n4. **Verify Celery Configuration**: Make sure that the rest of your Celery configuration doesn't have any conflicting settings. You might want to check your settings related to task routing and queues.\n\nBy making sure that the periodic task configuration explicitly specifies the `celery_periodic` queue, and ensuring the worker is listening to this queue, your setup should work as expected. If the problem persists, double-check your Celery logs for any errors or warnings that might provide more insights."
    }
]