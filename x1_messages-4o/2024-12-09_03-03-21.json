[
    {
        "role": "user",
        "content": "How can I run a function at the end of all tests in Pytest? I am looking for something of a global teardown function. I found an example online and some clues in the Pytest documentation, but these don't quite meet my requirements as they run the function at the beginning of the tests. I also came across the function `pytest_runtest_teardown()`, but it is called after each test, not after all tests. Additionally, it would be useful if this function could be triggered only when all tests have passed."
    },
    {
        "role": "assistant",
        "content": "To run a function at the end of all tests in Pytest, you can use the `pytest_sessionfinish` hook, which is designed to perform actions after the entire test session is completed. This hook can be placed in the `conftest.py` file, which is automatically discovered by Pytest.\n\nHere's how you can implement a global teardown function using `pytest_sessionfinish`:\n\n1. Create or edit the `conftest.py` file in your test directory.\n\n2. Define the `pytest_sessionfinish` hook and include your teardown logic there.\n\n3. To ensure the function only runs if all tests have passed, you can inspect the test outcomes.\n\nHere's an example:\n\n```python\n# conftest.py\n\nimport pytest\n\ndef pytest_sessionfinish(session, exitstatus):\n    \"\"\"\n    This hook is called after the whole test run has completed.\n    \"\"\"\n    if exitstatus == 0:\n        # All tests passed\n        print(\"All tests passed. Running global teardown function.\")\n        global_teardown()\n\ndef global_teardown():\n    # Your teardown logic here\n    print(\"Performing global teardown tasks.\")\n```\n\nIn this example:\n\n- `pytest_sessionfinish` is the hook that's called when the session finishes. The `exitstatus` parameter can be checked to determine the result of the test run.\n- An `exitstatus` of `0` indicates that all tests passed successfully.\n- The `global_teardown` function contains the logic you want to execute after all tests have passed.\n\nWith this setup, the `global_teardown` function will only run if all tests pass successfully. If any test fails, it won't be executed."
    }
]