[
    {
        "role": "user",
        "content": "How can I work with High Efficiency Image File (HEIF) format, also known as .HEIC files, in Python? I am looking to do file conversion, extract metadata and other operations on these files. I tried using Python 3.7 and Pillow, but I encountered an OSError. I also attempted using ImageMagick and Wand, but was unsuccessful. Are there any alternatives available for programmatically converting these files?\n\nHere is the error I encountered with Pillow:\n\n```\n$ ipython\nPython 3.7.0 (default, Oct  2 2018, 09:20:07)\nType 'copyright', 'credits' or 'license' for more information\nIPython 7.2.0 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: from PIL import Image\n\nIn [2]: img = Image.open('IMG_2292.HEIC')\n---------------------------------------------------------------------------\nOSError                                   Traceback (most recent call last)\n<ipython-input-2-fe47106ce80b> in <module>\n----> 1 img = Image.open('IMG_2292.HEIC')\n\n~/.env/py3/lib/python3.7/site-packages/PIL/Image.py in open(fp, mode)\n   2685         warnings.warn(message)\n   2686     raise IOError(\"cannot identify image file %r\"\n-> 2687                   % (filename if filename else fp))\n   2688\n   2689 #\n\nOSError: cannot identify image file 'IMG_2292.HEIC'\n```\n\nAnd this is the error when using ImageMagick and Wand:\n\n```\n$ ipython\nPython 3.7.0 (default, Oct  2 2018, 09:20:07)\nType 'copyright', 'credits' or 'license' for more information\nIPython 7.2.0 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: from wand.image import Image\n\nIn [2]: with Image(filename='img.jpg') as img:\n   ...:     print(img.size)\n   ...:\n(4032, 3024)\n\nIn [3]: with Image(filename='img.HEIC') as img:\n   ...:     print(img.size)\n   ...:\n---------------------------------------------------------------------------\nMissingDelegateError                      Traceback (most recent call last)\n<ipython-input-3-9d6f58c40f95> in <module>\n----> 1 with Image(filename='ces2.HEIC') as img:\n      2     print(img.size)\n      3\n\n~/.env/py3/lib/python3.7/site-packages/wand/image.py in __init__(self, image, blob, file, filename, format, width, height, depth, background, resolution, pseudo)\n   4603                     self.read(blob=blob, resolution=resolution)\n   4604                 elif filename is not None:\n-> 4605                     self.read(filename=filename, resolution=resolution)\n   4606                 # clear the wand format, otherwise any subsequent call to\n   4607                 # MagickGetImageBlob will silently change the image to this\n\n~/.env/py3/lib/python3.7/site-packages/wand/image.py in read(self, file, filename, blob, resolution)\n   4894             r = library.MagickReadImage(self.wand, filename)\n   4895         if not r:\n-> 4896             self.raise_exception()\n   4897\n   4898     def save(self, file=None, filename=None):\n\n~/.env/py3/lib/python3.7/site-packages/wand/resource.py in raise_exception(self, stacklevel)\n    220             warnings.warn(e, stacklevel=stacklevel + 1)\n    221         elif isinstance(e, Exception):\n--> 222             raise e\n    223\n    224     def __enter__(self):\n\nMissingDelegateError: no decode delegate for this image format `HEIC' @ error/constitute.c/ReadImage/556\n```"
    },
    {
        "role": "assistant",
        "content": "To work with HEIC files in Python, you can try using the `pyheif` library, which provides a way to decode HEIC files and convert them to other formats supported by Pillow. Here's a step-by-step guide on how to use `pyheif` for your needs:\n\n1. **Install Required Libraries:**\n\n   First, you need to install the necessary Python packages. You can do this using pip:\n\n   ```bash\n   pip install pyheif pillow\n   ```\n\n2. **Convert HEIC to JPEG/PNG:**\n\n   You can use `pyheif` to read the HEIC file and then convert it to a format supported by Pillow, such as JPEG or PNG. Here's how you can do it:\n\n   ```python\n   import pyheif\n   from PIL import Image\n\n   # Open the HEIC file\n   heif_file = pyheif.read(\"IMG_2292.HEIC\")\n\n   # Convert the HEIC image to a Pillow Image object\n   image = Image.frombytes(\n       heif_file.mode, \n       heif_file.size, \n       heif_file.data,\n       \"raw\",\n       heif_file.mode,\n       heif_file.stride,\n   )\n\n   # Save the image in a different format (e.g., JPEG)\n   image.save(\"IMG_2292_converted.jpg\", \"JPEG\")\n   ```\n\n3. **Extract Metadata:**\n\n   The `pyheif` library also allows you to access metadata of the HEIC files:\n\n   ```python\n   # Access metadata\n   metadata = heif_file.metadata\n\n   # Print out metadata\n   for item in metadata:\n       print(item['type'], item['data'])\n   ```\n\n4. **Using ImageMagick for HEIC Support:**\n\n   If you prefer using ImageMagick, ensure that your ImageMagick installation supports HEIC. You need to have the HEIF delegate library installed for ImageMagick to handle this format. On Linux, you can install the `libheif` package:\n\n   ```bash\n   sudo apt-get install libheif-dev\n   ```\n\n   After installing, recompile ImageMagick with HEIF support. You can check if HEIC is supported by running:\n\n   ```bash\n   convert -list format | grep HEIC\n   ```\n\nBy following these steps, you should be able to work with HEIC files in Python effectively, performing conversions and extracting metadata as needed."
    }
]