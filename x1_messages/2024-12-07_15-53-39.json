[
    {
        "role": "user",
        "content": "Design a SQL query that retrieves data from a relational database containing employee records. The query should return all employees who have been with the company for more than five years and whose salary is above the average salary of their respective departments. PLAINFORMAT"
    },
    {
        "role": "assistant",
        "content": "Certainly! To design this SQL query, we need to consider a few things about the database schema. Typically, an employee database might have tables like `employees` and `departments`, with relevant fields such as employee ID, name, hire date, salary, and department ID.\n\nAssuming the following schema:\n\n- **employees** table:\n\n  - employee_id (primary key)\n\n  - first_name\n\n  - last_name\n\n  - hire_date\n\n  - salary\n\n  - department_id (foreign key referencing departments.department_id)\n\n- **departments** table:\n\n  - department_id (primary key)\n\n  - department_name\n\nGiven this, we need to:\n\n1. Calculate the number of years each employee has been with the company.\n\n2. Determine the average salary for each department.\n\n3. Select employees who have been with the company for more than five years and whose salary exceeds the average salary of their department.\n\nHere's how you can achieve this:\n\n### Step-by-Step Solution\n\n1. **Calculate the number of years an employee has been with the company:**\n\n   We can use the `DATEDIFF` function to find the difference between the current date and the hire date, then divide by 365 to get the number of years.\n\n2. **Calculate the average salary per department:**\n\n   We can use a subquery or a Common Table Expression (CTE) to compute the average salary for each department.\n\n3. **Filter employees based on the conditions:**\n\n   Select employees who have been with the company for more than five years and whose salary is greater than the average salary of their department.\n\n### Final SQL Query\n\n```sql\nSELECT \n    e.employee_id,\n    e.first_name,\n    e.last_name,\n    e.hire_date,\n    e.salary,\n    d.department_name\nFROM \n    employees e\nJOIN \n    departments d ON e.department_id = d.department_id\nWHERE \n    DATEDIFF(CURDATE(), e.hire_date) / 365 > 5\n    AND e.salary > (\n        SELECT AVG(e2.salary)\n        FROM employees e2\n        WHERE e2.department_id = e.department_id\n    );\n```\n\n### Explanation\n\n- **Joining Tables:** We join the `employees` table with the `departments` table on the `department_id` to get the department name.\n\n- **Calculating Tenure:** We use `DATEDIFF(CURDATE(), e.hire_date) / 365` to calculate the number of years each employee has been with the company.\n\n- **Average Salary Subquery:** For each employee, we compute the average salary of their department using a subquery that averages salaries where the department ID matches.\n\n- **Filter Conditions:** We filter employees who have been with the company for more than five years and whose salary exceeds the department's average salary.\n\nThis query ensures that we retrieve the relevant employees based on the specified criteria."
    }
]