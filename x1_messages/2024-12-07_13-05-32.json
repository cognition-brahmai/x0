[
    {
        "role": "user",
        "content": "Given a SQL database with tables 'orders', 'customers' and 'products', write a query that returns the total revenue per product category for each customer. The 'orders' table has columns 'customer_id', 'product_id' and 'quantity'; the 'customers' table has 'id' and 'name'; and the 'products' table has 'id', 'category' and 'price'."
    },
    {
        "role": "assistant",
        "content": "To achieve this, you need to join the 'orders', 'customers', and 'products' tables based on their relationships and then group the results to calculate the total revenue per product category for each customer.\n\nHere's how you can structure your SQL query:\n\n1. **Join the tables:**\n   - Join 'orders' with 'customers' using 'customer_id' from 'orders' and 'id' from 'customers'.\n   - Join 'orders' with 'products' using 'product_id' from 'orders' and 'id' from 'products'.\n\n2. **Calculate revenue:**\n   - Revenue for each order is calculated as 'quantity' multiplied by 'price'.\n\n3. **Group the results:**\n   - Group by 'customer_id', 'name', and 'category' to get the total revenue per product category for each customer.\n\n4. **Select the required columns:**\n   - Select 'customer_id', 'name', 'category', and the sum of revenue.\n\nHere is the SQL query that accomplishes this:\n\n```sql\nSELECT\n    c.id AS customer_id,\n    c.name AS customer_name,\n    p.category AS product_category,\n    SUM(o.quantity * p.price) AS total_revenue\nFROM\n    orders o\nJOIN\n    customers c ON o.customer_id = c.id\nJOIN\n    products p ON o.product_id = p.id\nGROUP BY\n    c.id, c.name, p.category\nORDER BY\n    c.id, p.category;\n```\n\n### Explanation:\n\n- **Joins:**\n  - We join 'orders' with 'customers' on 'customer_id' to get customer details.\n  - We join 'orders' with 'products' on 'product_id' to get product details including category and price.\n\n- **Revenue Calculation:**\n  - For each order, revenue is calculated as the product of 'quantity' and 'price'.\n\n- **Grouping:**\n  - We group the results by 'customer_id', 'customer_name', and 'product_category' to aggregate the revenue for each category per customer.\n\n- **Ordering:**\n  - The results are ordered by 'customer_id' and 'product_category' for better readability.\n\nThis query will provide a list of customers along with the total revenue they have generated in each product category."
    }
]